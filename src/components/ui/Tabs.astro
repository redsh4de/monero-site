---
import crypto from "node:crypto";

interface Props {
  labels: string[]; // One label per panel slot (panel-0 ... panel-9)
  links?: string[]; // Optional array of URLs, if provided, renders as navigation links instead of same-page tabs
  id?: string; // Optional stable id if multiple components on a page
  initial?: number; // 0-based default tab
  activeIndex?: number; // 0-based active tab for navigation mode
}

const { labels = [], links, id, initial = 0, activeIndex }: Props = Astro.props;
if (!Array.isArray(labels) || labels.length === 0) {
  throw new Error("<Tabs> needs a non-empty labels array.");
}
if (labels.length > 10) {
  throw new Error("<Tabs> supports up to 10 tabs.");
}
if (links && links.length !== labels.length) {
  throw new Error("<Tabs> links array must match labels array length.");
}
if (links && labels.some((_, i) => Astro.slots.has(`panel-${i}`))) {
  throw new Error("<Tabs> cannot have both links and slot content.");
}
const uid = id ?? `tabs-${crypto.randomUUID()}`;
const I = (n: number) =>
  Math.min(Math.max(0, Number(n) || 0), labels.length - 1);
const active = I(initial);
---

<div class="tabs" id={uid}>
  {
    links ? (
      <div class="tab-header">
        {labels.map((label, i) => (
          <a
            class:list={["tab-label", activeIndex === i && "active"]}
            href={links[i]}
          >
            {label}
          </a>
        ))}
      </div>
    ) : (
      <>
        {labels.map((_, i) => (
          <input
            type="radio"
            name={uid}
            id={`${uid}-${i}`}
            checked={active === i}
            aria-controls={`${uid}-panel-${i}`}
            role="tab"
          />
        ))}

        <div class="tab-header">
          {labels.map((label, i) => (
            <label class="tab-label" for={`${uid}-${i}`}>
              {label}
            </label>
          ))}
        </div>

        <div class="tab-content">
          {labels[0] && (
            <div
              class="panel"
              id={`${uid}-panel-0`}
              role="tabpanel"
              aria-labelledby={`${uid}-0`}
            >
              <slot name="panel-0" />
            </div>
          )}
          {labels[1] && (
            <div
              class="panel"
              id={`${uid}-panel-1`}
              role="tabpanel"
              aria-labelledby={`${uid}-1`}
            >
              <slot name="panel-1" />
            </div>
          )}
          {labels[2] && (
            <div
              class="panel"
              id={`${uid}-panel-2`}
              role="tabpanel"
              aria-labelledby={`${uid}-2`}
            >
              <slot name="panel-2" />
            </div>
          )}
          {labels[3] && (
            <div
              class="panel"
              id={`${uid}-panel-3`}
              role="tabpanel"
              aria-labelledby={`${uid}-3`}
            >
              <slot name="panel-3" />
            </div>
          )}
          {labels[4] && (
            <div
              class="panel"
              id={`${uid}-panel-4`}
              role="tabpanel"
              aria-labelledby={`${uid}-4`}
            >
              <slot name="panel-4" />
            </div>
          )}
          {labels[5] && (
            <div
              class="panel"
              id={`${uid}-panel-5`}
              role="tabpanel"
              aria-labelledby={`${uid}-5`}
            >
              <slot name="panel-5" />
            </div>
          )}
          {labels[6] && (
            <div
              class="panel"
              id={`${uid}-panel-6`}
              role="tabpanel"
              aria-labelledby={`${uid}-6`}
            >
              <slot name="panel-6" />
            </div>
          )}
          {labels[7] && (
            <div
              class="panel"
              id={`${uid}-panel-7`}
              role="tabpanel"
              aria-labelledby={`${uid}-7`}
            >
              <slot name="panel-7" />
            </div>
          )}
          {labels[8] && (
            <div
              class="panel"
              id={`${uid}-panel-8`}
              role="tabpanel"
              aria-labelledby={`${uid}-8`}
            >
              <slot name="panel-8" />
            </div>
          )}
          {labels[9] && (
            <div
              class="panel"
              id={`${uid}-panel-9`}
              role="tabpanel"
              aria-labelledby={`${uid}-9`}
            >
              <slot name="panel-9" />
            </div>
          )}
        </div>
      </>
    )
  }
</div>

<style lang="scss">
  .tabs {
    width: 100%;
  }

  .tabs input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .tab-header {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(12rem, 1fr));
    box-sizing: border-box;

    width: max-content;
    max-width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 2rem;
    overflow: hidden;
    margin-bottom: 2rem;
  }

  .tab-label {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem 2rem;
    cursor: pointer;
    font-weight: 600;
    user-select: none;
    transition: background 0.3s ease;
    text-decoration: none;
    border-radius: 2rem;
    white-space: nowrap;
  }

  .tab-label:hover {
    background: var(--card-hover-color);
  }

  .tab-label.active {
    background: var(--card-color);
  }

  .panel {
    display: none;
  }

  @media (max-width: 1200px) {
    .tab-header {
      width: unset;
    }
  }

  @media (max-width: 400px) {
    .tab-header {
      grid-template-columns: 1fr;
    }
    .tab-label {
      border-radius: unset;
    }
  }

  @for $i from 0 through 9 {
    input[id$="-#{$i}"]:checked ~ .tab-header label[for$="-#{$i}"] {
      background: var(--card-color);
    }
  }

  @for $i from 0 through 9 {
    input[id$="-#{$i}"]:checked ~ .tab-content .panel[id$="-panel-#{$i}"] {
      display: block;
    }
  }
</style>
