---
import moon from "@/assets/icons/mask/moon.avif";
import sun from "@/assets/icons/mask/sun.avif";
import MaskIcon from "@/components/ui/MaskIcon.astro";
---

<button
  id="header--theme-toggle"
  type="button"
  aria-label="Toggle theme"
  hidden
>
  <span class="sun"><MaskIcon src={sun} size="1.5rem" /></span>
  <span class="moon"><MaskIcon src={moon} size="1.5rem" /></span>
</button>

<style>
  #header--theme-toggle {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    border: none;
    padding: 0;
    background: transparent;
    color: inherit;
  }

  #header--theme-toggle[hidden] {
    display: none;
  }

  #header--theme-toggle:hover,
  #header--theme-toggle:focus-visible {
    color: var(--heading-color);
  }

  .sun,
  .moon {
    line-height: 0;
  }

  /* In light mode, show moon */
  .sun {
    display: none;
  }
  .moon {
    display: block;
  }

  /* In dark mode, show sun */
  :global(:root[data-theme="dark"]) .sun {
    display: block;
  }
  :global(:root[data-theme="dark"]) .moon {
    display: none;
  }
</style>

<script>
  const headerThemeToggle = document.getElementById("header--theme-toggle")!;
  const root = document.documentElement;
  const prefersDark = matchMedia("(prefers-color-scheme: dark)");

  // Theme already applied by Layout's inline script, just show the button
  headerThemeToggle.hidden = false;
  headerThemeToggle.onclick = () =>
    localStorage.setItem(
      "theme",
      window.applyTheme(root.dataset.theme !== "dark"),
    );

  // Respond to system preference changes
  prefersDark.onchange = (e) => window.applyTheme(e.matches);
</script>
