name: "Validate Download Hashes"

on:
  push:
    paths:
      - "public/downloads/hashes.txt"
  pull_request:
    paths:
      - "public/downloads/hashes.txt"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-download-hashes:
    name: "Validate signed hashes and downloads"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            coreutils \
            curl \
            gnupg \
            git \
            bzip2 \
            diffutils \
            bash \
            tar \
            transmission-cli

      - name: Verify hashes.txt signature
        run: |
          set -euo pipefail

          export GNUPGHOME="$(mktemp -d)"

          curl -sSfL --proto '=https' --tlsv1.2 \
            "https://raw.githubusercontent.com/monero-project/monero/master/utils/gpg_keys/binaryfate.asc" |
            gpg --import

          gpg --batch --verify public/downloads/hashes.txt

      - name: Download releases and verify hashes
        run: |
          set -euo pipefail

          HASH_FILE="public/downloads/hashes.txt"
          manifest="$PWD/.hash-manifest"
          downloads="$PWD/.download-list"

          : > "$manifest"
          : > "$downloads"

          # Expecting "filename" lines matching /monero-/
          awk '/monero-/ {print $1, $2}' "$HASH_FILE" |
          while IFS=' ' read -r hash filename; do
            [ -z "$filename" ] && continue

            dir="cli"
            case "$filename" in
              *gui*) dir="gui" ;;
            esac

            url="https://dlsrc.getmonero.org/${dir}/${filename}"

            if [ -z "$hash" ]; then
              echo "Missing hash for $filename" >&2
              exit 1
            fi

            printf '%s  %s\n' "$hash" "$filename" >> "$manifest"
            printf '%s|%s\n' "$url" "$filename" >> "$downloads"
          done

          if [ ! -s "$downloads" ]; then
            echo "No downloads listed in hashes.txt (download list is empty)" >&2
            exit 1
          fi

          while IFS='|' read -r url filename; do
            [ -z "$url" ] && continue
            echo "Downloading $filename from $url"
            curl -sSfL --proto '=https' --tlsv1.2 "$url" -o "$filename"
          done < "$downloads"

          sha256sum -c "$manifest"
      
      - name: Validate source integrity
        run: |
          set -euo pipefail

          # Derive version numbers for CLI and GUI from hashes.txt
          version_gui=$(awk '/monero-gui-source-v/ {print $2}' public/downloads/hashes.txt | awk -F".tar.bz2" '{print $1}' | awk -F"-" '{print $4}')
          version_cli=$(awk '/monero-source-v/ {print $2}' public/downloads/hashes.txt | awk -F".tar.bz2" '{print $1}' | awk -F"-" '{print $3}')
          
          echo -e "\n--> GUI version: $version_gui \n--> CLI version: $version_cli"
          mkdir validate_sources
          cd validate_sources

          # Download / verify git-archive-all.sh
          curl -O https://raw.githubusercontent.com/fabacab/git-archive-all.sh/fc86194f00b678438f9210859597f6eead28e765/git-archive-all.sh
          echo "db62e9a824866989c9d080f008ec06d81421cf94bed3762acba3b9148607af2d git-archive-all.sh" | sha256sum -c
          chmod +x git-archive-all.sh

          echo -e "--> Generating tarballs..."
          # CLI
          git clone --recursive -b $version_cli --depth 1 --shallow-submodule https://github.com/monero-project/monero.git monero.git && cd monero.git && ../git-archive-all.sh --prefix monero-source-${version_cli}/ --format tar --tree-ish $version_cli ../monero-source-${version_cli}.tar && cd .. && bzip2 monero-source-${version_cli}.tar
          # GUI
          git clone --recursive -b $version_gui --depth 1 --shallow-submodule https://github.com/monero-project/monero-gui.git monero-gui.git && cd monero-gui.git && ../git-archive-all.sh --prefix monero-gui-source-${version_gui}/ --format tar --tree-ish $version_gui ../monero-gui-source-${version_gui}.tar && cd .. && bzip2 monero-gui-source-${version_gui}.tar
          mkdir yours
          cp monero-gui-source-${version_gui}.tar.bz2 yours/.
          cp monero-source-${version_cli}.tar.bz2 yours/.
          mkdir from_website

          echo -e "\n--> Move tarballs from getmonero..."
          mv ../monero-gui-source-${version_gui}.tar.bz2 from_website/.
          mv ../monero-source-${version_cli}.tar.bz2 from_website/.

          echo -e "\n--> Unpacking all..."
          bunzip2 yours/*.bz2
          bunzip2 from_website/*.bz2
          tar xf yours/monero-source-${version_cli}.tar -C yours/
          tar xf yours/monero-gui-source-${version_gui}.tar -C yours/
          tar xf from_website/monero-source-${version_cli}.tar -C from_website/
          tar xf from_website/monero-gui-source-${version_gui}.tar -C from_website

          # Compare directories
          echo -e "\n--> Comparing CLI directories"
          diff -r yours/monero-source-$version_cli from_website/monero-source-$version_cli
          echo -e "\n--> Comparing GUI directories"
          diff -r yours/monero-gui-source-$version_gui from_website/monero-gui-source-$version_gui
      
      - name: Verify torrent + magnet links
        run: |
          set -euo pipefail

          HASH_FILE="public/downloads/hashes.txt"

          # Derive version numbers for CLI and GUI from hashes.txt
          version_gui=$(awk '/monero-gui-source-v/ {print $2}' public/downloads/hashes.txt | awk -F".tar.bz2" '{print $1}' | awk -F"-" '{print $4}')
          version_cli=$(awk '/monero-source-v/ {print $2}' public/downloads/hashes.txt | awk -F".tar.bz2" '{print $1}' | awk -F"-" '{print $3}')

          # Clone and pin the monero-torrent repo
          git clone --recurse-submodules https://github.com/plowsof/monero-torrent.git
          cd monero-torrent
          git reset --hard 587c43dbd6d9fe424edb376b7c5fa2f42589d116
          cd ..

          # Move the already-downloaded monero-* files into cdn
          mkdir monero-torrent/cdn
          awk '/monero-/ {print $2}' "$HASH_FILE" | while IFS= read -r f; do
            [ -z "$f" ] && continue
            if [ ! -f "$f" ]; then
              echo "Expected file $f is missing in workspace" >&2
              exit 1
            fi
            mv "$f" monero-torrent/cdn/
          done

          # Add GPG key and hashes.txt into cdn
          wget -q \
            https://raw.githubusercontent.com/monero-project/monero/master/utils/gpg_keys/binaryfate.asc \
            -O monero-torrent/cdn/binaryfate.asc

          cp "$HASH_FILE" monero-torrent/cdn/hashes.txt

          # Build torrents locally
          cd monero-torrent
          docker compose --profile local up --build

          # Paths to locally-built torrents
          local_cli_torrent="watch/monero-${version_cli}.torrent"
          local_gui_torrent="watch/monero-gui-${version_gui}.torrent"

          if [ ! -f "$local_cli_torrent" ] || [ ! -f "$local_gui_torrent" ]; then
            echo "Local torrent files were not created as expected" >&2
            ls -R
            exit 1
          fi

          # Extract magnet links from locally built torrents
          MAGNET_LINK_CLI="$(transmission-show -m "$local_cli_torrent")"
          MAGNET_LINK_GUI="$(transmission-show -m "$local_gui_torrent")"

          cd ..

          # Download torrents from CDN (replace with the monero URLs)
          CDN_CLI_URL="https://github.com/plowsof/monero-torrent/releases/download/v0.18.4.4/monero-v0.18.4.4.torrent"
          CDN_GUI_URL="https://github.com/plowsof/monero-torrent/releases/download/v0.18.4.4/monero-gui-v0.18.4.4.torrent"

          wget -q "$CDN_CLI_URL" -O "monero-${version_cli}.torrent"
          wget -q "$CDN_GUI_URL" -O "monero-gui-${version_gui}.torrent"

          CDN_MAGNET_LINK_CLI="$(transmission-show -m "monero-${version_cli}.torrent")"
          CDN_MAGNET_LINK_GUI="$(transmission-show -m "monero-gui-${version_gui}.torrent")"

          # Compare local vs CDN magnets
          if [ "$MAGNET_LINK_CLI" != "$CDN_MAGNET_LINK_CLI" ]; then
            echo "CLI torrent magnet mismatch between local build and CDN version" >&2
            echo "Local: $MAGNET_LINK_CLI" >&2
            echo "CDN : $CDN_MAGNET_LINK_CLI" >&2
            exit 1
          fi

          if [ "$MAGNET_LINK_GUI" != "$CDN_MAGNET_LINK_GUI" ]; then
            echo "GUI torrent magnet mismatch between local build and CDN version" >&2
            echo "Local: $MAGNET_LINK_GUI" >&2
            echo "CDN : $CDN_MAGNET_LINK_GUI" >&2
            exit 1
          fi

          echo "Torrent files and magnet links match local build and CDN."